[üè† Home](../../../../index.md) > [Backend](../../../index.md) > [Architecture](../../index.md) > [Flows](./index.md)

# üîê Spec: Authentication Flow

**Status:** Draft

## 1. –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
–≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ `backend/core/config.py`.

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| **ACCESS_TOKEN_EXPIRE** | 30 –º–∏–Ω—É—Ç | –ö–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–π —Ç–æ–∫–µ–Ω. –ï—Å–ª–∏ —É–∫—Ä–∞–¥—É—Ç ‚Äî –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ 30 –º–∏–Ω—É—Ç. |
| **REFRESH_TOKEN_EXPIRE** | 30 –¥–Ω–µ–π | –î–æ–ª–≥–æ–∂–∏–≤—É—â–∏–π —Ç–æ–∫–µ–Ω. –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–µ –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ –º–µ—Å—è—Ü. |
| **ALGORITHM** | HS256 | –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥–ø–∏—Å–∏ JWT. |

## 2. –¢–∏–ø—ã –¢–æ–∫–µ–Ω–æ–≤

### A. Access Token (Stateless)
*   **–¢–∏–ø:** JWT (JSON Web Token).
*   **–•—Ä–∞–Ω–µ–Ω–∏–µ (Server):** –ù–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è. –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∏ (Signature) –∏ —Å—Ä–æ–∫—É –¥–µ–π—Å—Ç–≤–∏—è (`exp`).
*   **–•—Ä–∞–Ω–µ–Ω–∏–µ (Client):** –í –ø–∞–º—è—Ç–∏ JS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è).
*   **–°–æ–¥–µ—Ä–∂–∏–º–æ–µ (Payload):** `sub` (user_id), `exp` (–≤—Ä–µ–º—è —Å–º–µ—Ä—Ç–∏), `type="access"`.

### B. Refresh Token (Stateful)
*   **–¢–∏–ø:** Opaque String (—Å–ª—É—á–∞–π–Ω–∞—è —Å—Ç—Ä–æ–∫–∞) –∏–ª–∏ JWT.
*   **–•—Ä–∞–Ω–µ–Ω–∏–µ (Server):** –•—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ `refresh_tokens`). –≠—Ç–æ **White List** ‚Äî —Ç–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω—ã –∏–∑ –±–∞–∑—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º–∏.
*   **–•—Ä–∞–Ω–µ–Ω–∏–µ (Client):** `localStorage` (–¥–ª—è MVP) –∏–ª–∏ `HttpOnly Cookie` (Best Practice, –Ω–æ —Å–ª–æ–∂–Ω–µ–µ —Å CORS). –†–µ—à–∏–ª–∏ –ø–æ–∫–∞ JSON –≤ `localStorage`.
*   **–†–æ–ª—å:** –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—É—é –ø–∞—Ä—É —Ç–æ–∫–µ–Ω–æ–≤.

## 3. –°—Ü–µ–Ω–∞—Ä–∏–∏ (Flows)

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –í—Ö–æ–¥ (Login)
1.  **Client:** –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `POST /auth/login` (email, password).
2.  **Server:**
    *   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–∞—Ä–æ–ª—å.
    *   –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `access_token` (JWT).
    *   –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `refresh_token` (random string).
    *   **DB:** –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç `refresh_token` + `user_id` + `expires_at` –≤ —Ç–∞–±–ª–∏—Ü—É `refresh_tokens`.
3.  **Client:** –ü–æ–ª—É—á–∞–µ—Ç –ø–∞—Ä—É —Ç–æ–∫–µ–Ω–æ–≤, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç Access –≤ –ø–∞–º—è—Ç—å, Refresh –≤ LocalStorage.

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ó–∞–ø—Ä–æ—Å –∫ –∑–∞—â–∏—â–µ–Ω–Ω–æ–º—É —Ä–µ—Å—É—Ä—Å—É
1.  **Client:** –î–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º `Authorization: Bearer <access_token>`.
2.  **Server:**
    *   –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç JWT.
    *   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å (Secret Key).
    *   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `exp` (–Ω–µ –ø—Ä–æ—Ç—É—Ö –ª–∏).
    *   *–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –í –ë–î –Ω–µ –ª–µ–∑–µ—Ç (–±—ã—Å—Ç—Ä–æ!).*
3.  **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ï—Å–ª–∏ –û–ö ‚Äî –æ—Ç–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Äî `401 Unauthorized`.

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ (Refresh Rotation) üî•
–°–∞–º—ã–π –≤–∞–∂–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å. –ò—Å–ø–æ–ª—å–∑—É–µ–º **Refresh Token Rotation** –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∫—Ä–∞–∂–∏.

1.  **Client:** –ü–æ–ª—É—á–∞–µ—Ç `401` –ø—Ä–∏ –æ–±—ã—á–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ. –ü–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ Access –ø—Ä–æ—Ç—É—Ö.
2.  **Client:** –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `POST /auth/refresh` (refresh_token).
3.  **Server:**
    *   –ò—â–µ—Ç —Ç–æ–∫–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ `refresh_tokens`.
    *   **–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω:** –û—à–∏–±–∫–∞ `401` (–≤–∑–ª–æ–º –∏–ª–∏ –ª–æ–≥–∞—É—Ç). –ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å–¥–µ–ª–∞—Ç—å Redirect –Ω–∞ Login.
    *   **–ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω, –Ω–æ –ø—Ä–æ—Ç—É—Ö:** –£–¥–∞–ª—è–µ—Ç –∏–∑ –ë–î, –æ—à–∏–±–∫–∞ `401`.
    *   **–ï—Å–ª–∏ –≤–∞–ª–∏–¥–µ–Ω:**
        1.  **–£–î–ê–õ–Ø–ï–¢** —Å—Ç–∞—Ä—ã–π `refresh_token` –∏–∑ –ë–î (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ!).
        2.  –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–æ–≤—É—é –ø–∞—Ä—É (New Access + New Refresh).
        3.  –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç New Refresh –≤ –ë–î.
4.  **Client:** –ó–∞–º–µ–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω—ã —É —Å–µ–±—è –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å.

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –í—ã—Ö–æ–¥ (Logout)
1.  **Client:** –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `POST /auth/logout`.
2.  **Server:** –£–¥–∞–ª—è–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π `refresh_token` –∏–∑ –ë–î.
3.  **–†–µ–∑—É–ª—å—Ç–∞—Ç:** Access —Ç–æ–∫–µ–Ω –µ—â–µ –∂–∏–≤–µ—Ç —Å–≤–æ–∏ X –º–∏–Ω—É—Ç (–∏–∑–¥–µ—Ä–∂–∫–∞ JWT), –Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ —É–∂–µ –Ω–µ–ª—å–∑—è.

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: "–í—ã–π—Ç–∏ —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤"
*   **Logic:** –£–¥–∞–ª–∏—Ç—å **–í–°–ï** –∑–∞–ø–∏—Å–∏ –∏–∑ `refresh_tokens` –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ `user_id`.

---
[üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é](../../../../index.md)
