[üè† Home](../../../../index.md) > [Backend](../../../index.md) > [Architecture](../../index.md) > [Domains](../index.md) > [Users](./index.md)

# üß™ Testing Strategy: Users Domain

## üéØ –§–∏–ª–æ—Å–æ—Ñ–∏—è –∏ –¶–µ–ª–∏

**–û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å:** –û–±–µ—Å–ø–µ—á–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –û—à–∏–±–∫–∏ –∑–¥–µ—Å—å –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã, —Ç–∞–∫ –∫–∞–∫ –≤–µ–¥—É—Ç –∫ —É—Ç–µ—á–∫–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—Ö–æ–¥–∞.

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
1.  **Security First:** –¢–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –ø–æ–∫—Ä—ã–≤–∞—Ç—å –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–Ω–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å, –ø—Ä–æ—Ç—É—Ö—à–∏–π —Ç–æ–∫–µ–Ω, –ø–æ–ø—ã—Ç–∫–∞ –≤–∑–ª–æ–º–∞).
2.  **Isolation:** –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–π –ë–î.
3.  **Flows:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç –ø–æ–ª–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏.

## üìä –ü–∏—Ä–∞–º–∏–¥–∞ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. Unit Tests (Services)
–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ `AuthService`.
*   **Scope:** –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤, –≤–∞–ª–∏–¥–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª (—É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å email).
*   **Mocking:** `IUserRepository`, `ITokenRepository`, `security` utils.

### 2. Integration Tests (API)
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ —Å —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î (SQLite/Postgres).
*   **Scope:** `AuthRouter`, `UserRouter`.
*   **Focus:** HTTP –∫–æ–¥—ã –æ—Ç–≤–µ—Ç–æ–≤, –≤–∞–ª–∏–¥–∞—Ü–∏—è Pydantic —Å—Ö–µ–º, —Ä–∞–±–æ—Ç–∞ Middleware.

---

## üß™ Unit Testing Specifications

### `AuthService`
**–§–∞–π–ª:** `tests/unit/users/test_auth_service.py`

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**
*   **Registration:**
    *   `test_register_success`: –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–∑–æ–≤–∞ `repo.create` —Å —Ö–µ—à–µ–º).
    *   `test_register_duplicate_email`: –û—à–∏–±–∫–∞, –µ—Å–ª–∏ email –∑–∞–Ω—è—Ç (Mock repo –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç User).
*   **Authentication:**
    *   `test_login_success`: –í–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å -> –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Ç–æ–∫–µ–Ω—ã.
    *   `test_login_wrong_password`: –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å -> –æ—à–∏–±–∫–∞ `AuthException`.
    *   `test_login_user_not_found`: Email –Ω–µ –Ω–∞–π–¥–µ–Ω -> –æ—à–∏–±–∫–∞.
*   **Tokens:**
    *   `test_refresh_token_success`: –í–∞–ª–∏–¥–Ω—ã–π refresh -> –Ω–æ–≤–∞—è –ø–∞—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤.
    *   `test_refresh_token_expired`: –ü—Ä–æ—Ç—É—Ö—à–∏–π refresh -> –æ—à–∏–±–∫–∞ + —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞.
    *   `test_refresh_token_reuse_detection` (Optional): –ï—Å–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

---

## üîó Integration Testing Specifications

### `Auth Flow`
**–§–∞–π–ª:** `tests/integration/users/test_auth_flow.py`

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∂–∏–∑–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–®–∞–≥–∏ —Ç–µ—Å—Ç–∞:**
1.  **Register:** POST `/auth/register` -> 201 Created.
2.  **Login:** POST `/auth/login` -> 200 OK + Tokens.
3.  **Me:** GET `/users/me` —Å Access Token -> 200 OK + –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è.
4.  **Refresh:** POST `/auth/refresh` -> 200 OK + –ù–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã.
5.  **Old Token:** GET `/users/me` —Å–æ —Å—Ç–∞—Ä—ã–º Access Token -> 401 Unauthorized (–ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è).
6.  **Logout:** POST `/auth/logout` -> 204 No Content.
7.  **Refresh after Logout:** POST `/auth/refresh` -> 401 Unauthorized.

### `Security Cases`
**–§–∞–π–ª:** `tests/integration/users/test_security.py`

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**
*   –ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ `/users/me` –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ -> 401.
*   –ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ —Å –ø–æ–¥–¥–µ–ª—å–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º (–Ω–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å) -> 401.
*   SQL Injection –≤ –ø–æ–ª–µ email (–ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ ORM —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç).

---

## üõ†Ô∏è Fixtures & Mocks

*   `mock_user_repo`: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –º–æ–∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
*   `mock_token_repo`: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –º–æ–∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Ç–æ–∫–µ–Ω–æ–≤.
*   `user_payload`: –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (email, password).
*   `auth_headers(token)`: –•–µ–ª–ø–µ—Ä –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ `Authorization: Bearer ...`.

---
[üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é](../../../../index.md)
