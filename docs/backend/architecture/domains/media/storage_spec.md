[üè† Home](../../../../index.md) > [Backend](../../../index.md) > [Architecture](../../index.md) > [Domains](../index.md) > [Media](./index.md)

# üíæ Spec: Media Storage & Validation (CAS)

**–î–æ–º–µ–Ω:** `apps.media`
**–°–ª–æ–π:** Service Layer (Business Logic)
**–°—Ç–∞—Ç—É—Å:** Implemented

## 1. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è: Content-Addressable Storage (CAS)
–ú—ã –æ—Ç–∫–∞–∑—ã–≤–∞–µ–º—Å—è –æ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –ø–æ –∏–º–µ–Ω–∏ (`cat.png`). –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–¥—Ö–æ–¥ CAS: –∞–¥—Ä–µ—Å —Ñ–∞–π–ª–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º—ã–º.

*   **–ê–ª–≥–æ—Ä–∏—Ç–º —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:** SHA-256.
*   **–ì–∞—Ä–∞–Ω—Ç–∏—è:** –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ñ–∞–π–ª—ã = –û–¥–∏–Ω —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫–µ (–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è).
*   **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ò–º—è —Ñ–∞–π–ª–∞ –Ω–∞ –¥–∏—Å–∫–µ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞.

## 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –§–∞–π–ª–æ–≤–æ–π –°–∏—Å—Ç–µ–º—ã (Sharding)
–ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã "–º–∏–ª–ª–∏–æ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –≤ –æ–¥–Ω–æ–π –ø–∞–ø–∫–µ", –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π —à–∞—Ä–¥–∏–Ω–≥ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö–µ—à–∞.

**–ü—Ä–∏–º–µ—Ä:**
*   –§–∞–π–ª: `cat.png`
*   SHA-256: `a1b2c3d4...`
*   –ü—É—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è: `media/storage/a1/b2/a1b2c3d4...` (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)
*   –ü—É—Ç—å –º–∏–Ω–∏–∞—Ç—é—Ä—ã: `media/storage/a1/b2/a1b2c3d4..._thumb.jpg`

**–§–æ—Ä–º—É–ª–∞ –ø—É—Ç–∏:**
```python
root / hash[0:2] / hash[2:4] / hash
```

## 3. –ü—Ä–æ—Ü–µ—Å—Å –ó–∞–≥—Ä—É–∑–∫–∏ (Upload Flow)
–≠—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ —Å–µ—Ä–≤–∏—Å–µ `MediaService`.

### –®–∞–≥ A: –í–∞–ª–∏–¥–∞—Ü–∏—è (Security First)
1.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞:** –í –ø—Ä–æ—Ü–µ—Å—Å–µ —á—Ç–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞ –º—ã —Å—á–∏—Ç–∞–µ–º –±–∞–π—Ç—ã. –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –ø—Ä–µ–≤—ã—à–∞–µ—Ç `MAX_UPLOAD_SIZE` (–∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞), –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è, –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —É–¥–∞–ª—è–µ—Ç—Å—è.
2.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ Magic Bytes:** (–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è) –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `python-magic` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞.

### –®–∞–≥ B: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –•–µ—à–∞ –∏ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
–ú—ã —á–∏—Ç–∞–µ–º —Ñ–∞–π–ª –ø–æ—Ç–æ–∫–æ–º (chunks) –ø–æ 64–ö–ë, —Å–∫–∞—Ä–º–ª–∏–≤–∞—è –∏—Ö `hashlib.sha256()`.
–û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–∏—à–µ–º –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª: `media/temp/upload_UUID.tmp`.

**DB Check:** –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –≤ –ë–î: `SELECT hash FROM files WHERE hash = :new_hash LIMIT 1`

*   **–ï–°–¢–¨ –í –ë–ê–ó–ï (Hit):**
    *   –§–∏–∑–∏—á–µ—Å–∫–∏ —Ñ–∞–π–ª –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º (–æ–Ω —É–∂–µ –µ—Å—Ç—å).
    *   –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª.
    *   –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `images` (—Å–≤—è–∑—å: –ù–æ–≤—ã–π –Æ–∑–µ—Ä -> –°—Ç–∞—Ä—ã–π –•–µ—à).
    *   –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ–º `ref_count` —É —Ñ–∞–π–ª–∞.
    *   –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö.
*   **–ù–ï–¢ –í –ë–ê–ó–ï (Miss):**
    *   –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É C.

### –®–∞–≥ C: –§–∏–∑–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (Atomic Write)
–ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é, –∏ —Å–µ—Ä–≤–µ—Ä —É–ø–∞–¥–µ—Ç –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ ‚Äî –º—ã –ø–æ–ª—É—á–∏–º –±–∏—Ç—ã–π —Ñ–∞–π–ª. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω **Atomic Save**:

1.  –î–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª `media/temp/upload_UUID.tmp` (–Ω–∞ —à–∞–≥–µ B).
2.  –î–µ–ª–∞–µ–º `shutil.move()` –≤ —Ü–µ–ª–µ–≤—É—é –ø–∞–ø–∫—É `media/storage/a1/b2/....`.
3.  **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã:** –°–æ–∑–¥–∞–µ–º `_thumb.jpg` (300px) —Ä—è–¥–æ–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º.

**–í–ê–ñ–ù–û:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `shutil.move()` –∏ `PIL` –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ (`run_in_threadpool`), —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å Event Loop.

## 4. –°—Ö–µ–º–∞ –î–∞–Ω–Ω—ã—Ö (Database Model)
–ù–∞–º –Ω—É–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ–Ω—è—Ç–∏–µ "–ö–∞—Ä—Ç–∏–Ω–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" –∏ "–§–∏–∑–∏—á–µ—Å–∫–∏–π –ë–ª–æ–±".

### –¢–∞–±–ª–∏—Ü–∞ `files` (Blob Storage)
–•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–∞—Ö.
*   `hash` (PK, CHAR(64))
*   `size_bytes` (INT)
*   `mime_type` (VARCHAR)
*   `created_at` (DATETIME)
*   `ref_count` (INT) ‚Äî —Å—á–µ—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ (–¥–ª—è —Å–±–æ—Ä—â–∏–∫–∞ –º—É—Å–æ—Ä–∞).

### –¢–∞–±–ª–∏—Ü–∞ `images` (User Assets)
–¢–æ, —á—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
*   `id` (PK, UUID)
*   `user_id` (FK -> Users)
*   `file_hash` (FK -> files.hash)
*   `filename` (VARCHAR) ‚Äî –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è ("my_cat.png")

---
[üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é](../../../../index.md)
