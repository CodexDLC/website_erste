[üè† Home](../../../../index.md) > [Backend](../../../index.md) > [Architecture](../../index.md) > [Domains](../index.md) > [Media](./index.md)

# üíæ Spec: Media Storage & Validation (CAS)

**–î–æ–º–µ–Ω:** `apps.media`
**–°–ª–æ–π:** Service Layer (Business Logic)
**–°—Ç–∞—Ç—É—Å:** Draft

## 1. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è: Content-Addressable Storage (CAS)
–ú—ã –æ—Ç–∫–∞–∑—ã–≤–∞–µ–º—Å—è –æ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –ø–æ –∏–º–µ–Ω–∏ (`cat.png`). –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–¥—Ö–æ–¥ CAS: –∞–¥—Ä–µ—Å —Ñ–∞–π–ª–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º—ã–º.

*   **–ê–ª–≥–æ—Ä–∏—Ç–º —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:** SHA-256.
*   **–ì–∞—Ä–∞–Ω—Ç–∏—è:** –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ñ–∞–π–ª—ã = –û–¥–∏–Ω —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫–µ (–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è).
*   **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ò–º—è —Ñ–∞–π–ª–∞ –Ω–∞ –¥–∏—Å–∫–µ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞.

## 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –§–∞–π–ª–æ–≤–æ–π –°–∏—Å—Ç–µ–º—ã (Sharding)
–ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã "–º–∏–ª–ª–∏–æ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –≤ –æ–¥–Ω–æ–π –ø–∞–ø–∫–µ", –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π —à–∞—Ä–¥–∏–Ω–≥ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö–µ—à–∞.

**–ü—Ä–∏–º–µ—Ä:**
*   –§–∞–π–ª: `cat.png`
*   SHA-256: `a1b2c3d4...`
*   –ü—É—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è: `media/storage/a1/b2/a1b2c3d4...` (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏–ª–∏ —Å .bin)

**–§–æ—Ä–º—É–ª–∞ –ø—É—Ç–∏:**
```python
root / hash[0:2] / hash[2:4] / hash
```

## 3. –ü—Ä–æ—Ü–µ—Å—Å –ó–∞–≥—Ä—É–∑–∫–∏ (Upload Flow)
–≠—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ —Å–µ—Ä–≤–∏—Å–µ `FileStorageService`.

### –®–∞–≥ A: –í–∞–ª–∏–¥–∞—Ü–∏—è (Security First)
–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ —á–∏—Ç–∞—Ç—å –≤–µ—Å—å —Ñ–∞–π–ª (–æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –æ–Ω 5–ì–ë, —Ö–æ—Ç—è —É –Ω–∞—Å –ª–∏–º–∏—Ç 5-10–ú–ë), –º—ã —á–∏—Ç–∞–µ–º –ø–µ—Ä–≤—ã–µ 2 –ö–ë (Magic Bytes).

1.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ Magic Bytes:** –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É `python-magic` –∏–ª–∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã.
    *   –ï—Å–ª–∏ —Ö–µ–¥–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç `image/png`, –∞ –±–∞–π—Ç—ã –≥–æ–≤–æ—Ä—è—Ç `application/x-dosexec` -> **Reject (400 Bad Request)**.
2.  **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞:** `Content-Length` —Ö–µ–¥–µ—Ä + —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç –±–∞–π—Ç–æ–≤ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏.

### –®–∞–≥ B: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –•–µ—à–∞ –∏ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
–ú—ã —á–∏—Ç–∞–µ–º —Ñ–∞–π–ª –ø–æ—Ç–æ–∫–æ–º (chunks) –ø–æ 64–ö–ë, —Å–∫–∞—Ä–º–ª–∏–≤–∞—è –∏—Ö `hashlib.sha256()`.
–ü–æ–ª—É—á–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π `file_hash`.

**DB Check:** –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –≤ –ë–î: `SELECT id FROM images WHERE file_hash = :new_hash LIMIT 1`

*   **–ï–°–¢–¨ –í –ë–ê–ó–ï (Hit):**
    *   –§–∏–∑–∏—á–µ—Å–∫–∏ —Ñ–∞–π–ª –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º (–æ–Ω —É–∂–µ –µ—Å—Ç—å).
    *   –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `images` (—Å–≤—è–∑—å: –ù–æ–≤—ã–π –Æ–∑–µ—Ä -> –°—Ç–∞—Ä—ã–π –•–µ—à).
    *   –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö.
*   **–ù–ï–¢ –í –ë–ê–ó–ï (Miss):**
    *   –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É C.

### –®–∞–≥ C: –§–∏–∑–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (Atomic Write)
–ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é, –∏ —Å–µ—Ä–≤–µ—Ä —É–ø–∞–¥–µ—Ç –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ ‚Äî –º—ã –ø–æ–ª—É—á–∏–º –±–∏—Ç—ã–π —Ñ–∞–π–ª. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω **Atomic Save**:

1.  –ü–∏—à–µ–º –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª: `media/temp/upload_UUID.tmp`.
2.  –ö–æ–≥–¥–∞ –∑–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ ‚Äî –¥–µ–ª–∞–µ–º `os.rename()` (–∏–ª–∏ `shutil.move`) –≤ —Ü–µ–ª–µ–≤—É—é –ø–∞–ø–∫—É `media/storage/a1/b2/....`.

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π –§–° ‚Äî –∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤ Linux/Windows.

## 4. –°—Ö–µ–º–∞ –î–∞–Ω–Ω—ã—Ö (Database Model)
–ù–∞–º –Ω—É–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ–Ω—è—Ç–∏–µ "–ö–∞—Ä—Ç–∏–Ω–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" –∏ "–§–∏–∑–∏—á–µ—Å–∫–∏–π –ë–ª–æ–±".

### –¢–∞–±–ª–∏—Ü–∞ `files` (Blob Storage) ‚Äî –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (–¥–ª—è –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏)
–•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–∞—Ö.
*   `hash` (PK, CHAR(64))
*   `size_bytes` (INT)
*   `mime_type` (VARCHAR)
*   `created_at` (DATETIME)
*   `ref_count` (INT) ‚Äî —Å—á–µ—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ (–¥–ª—è —Å–±–æ—Ä—â–∏–∫–∞ –º—É—Å–æ—Ä–∞).

### –¢–∞–±–ª–∏—Ü–∞ `images` (User Assets)
–¢–æ, —á—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
*   `id` (PK, UUID)
*   `user_id` (FK -> Users)
*   `file_hash` (FK -> files.hash –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ Index)
*   `filename` (VARCHAR) ‚Äî –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è ("my_cat.png")
*   `is_private` (BOOL)

---
[üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é](../../../../index.md)
