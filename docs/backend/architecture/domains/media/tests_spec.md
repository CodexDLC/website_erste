[üè† Home](../../../../index.md) > [Backend](../../../index.md) > [Architecture](../../index.md) > [Domains](../index.md) > [Media](./index.md)

# üß™ Testing Strategy: Media Domain

## üéØ –§–∏–ª–æ—Å–æ—Ñ–∏—è –∏ –¶–µ–ª–∏

**–û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (—Ñ–∞–π–ª–æ–≤) –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (CAS).

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
1.  **Data Integrity:** –§–∞–π–ª –Ω–∞ –¥–∏—Å–∫–µ –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å–∏ –≤ –ë–î.
2.  **Cleanup:** –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –¥–æ–ª–∂–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è (—É–¥–∞–ª—è—Ç—å —Ñ–∞–π–ª —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –±–æ–ª—å—à–µ –Ω–∏–∫–µ–º –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è).
3.  **Mock Storage:** –í —é–Ω–∏—Ç-—Ç–µ—Å—Ç–∞—Ö –Ω–µ –ø–∏—à–µ–º –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –¥–∏—Å–∫, –∏—Å–ø–æ–ª—å–∑—É–µ–º `io.BytesIO` –∏–ª–∏ –º–æ–∫–∏ `aiofiles`.

## üìä –ü–∏—Ä–∞–º–∏–¥–∞ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. Unit Tests (Services)
–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ `MediaService`.
*   **Scope:** –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ö–µ—à–µ–π, –ª–æ–≥–∏–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞.
*   **Mocking:** `IMediaRepository`, —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ (`aiofiles`, `os`).

### 2. Integration Tests (API)
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–ø–∫–∏ (`tmp_path`).
*   **Scope:** `MediaRouter`.
*   **Focus:** Upload multipart/form-data, Serving static files (–µ—Å–ª–∏ —á–µ—Ä–µ–∑ API), —É–¥–∞–ª–µ–Ω–∏–µ.

---

## üß™ Unit Testing Specifications

### `MediaService`
**–§–∞–π–ª:** `tests/unit/media/test_media_service.py`

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**
*   **Upload (New File):**
    *   –í—Ö–æ–¥: `UploadFile` (stream).
    *   –û–∂–∏–¥–∞–Ω–∏–µ: –í—ã—á–∏—Å–ª–µ–Ω —Ö–µ—à, –≤—ã–∑–≤–∞–Ω `shutil.move` (–º–æ–∫), –≤—ã–∑–≤–∞–Ω `repo.create_file` –∏ `repo.create_image`.
*   **Upload (Deduplication):**
    *   –í—Ö–æ–¥: –§–∞–π–ª, —Ö–µ—à –∫–æ—Ç–æ—Ä–æ–≥–æ —É–∂–µ –µ—Å—Ç—å –≤ –º–æ–∫–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (`get_file_by_hash` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç).
    *   –û–∂–∏–¥–∞–Ω–∏–µ: `shutil.move` –ù–ï –≤—ã–∑–≤–∞–Ω, –≤—ã–∑–≤–∞–Ω —Ç–æ–ª—å–∫–æ `repo.create_image`.
*   **Delete (Owner):**
    *   –í—Ö–æ–¥: `user_id` —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏.
    *   –û–∂–∏–¥–∞–Ω–∏–µ: –í—ã–∑–≤–∞–Ω `repo.delete_image`.
*   **Delete (Not Owner):**
    *   –í—Ö–æ–¥: `user_id` —á—É–∂–æ–π.
    *   –û–∂–∏–¥–∞–Ω–∏–µ: –û—à–∏–±–∫–∞ `PermissionDeniedException`.

---

## üîó Integration Testing Specifications

### `Upload & Gallery Flow`
**–§–∞–π–ª:** `tests/integration/media/test_media_flow.py`

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É, –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ.

**–®–∞–≥–∏ —Ç–µ—Å—Ç–∞:**
1.  **Upload:** POST `/media/upload` (—Ñ–∞–π–ª `cat.jpg`) -> 200 OK + JSON (url).
2.  **Verify Storage:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ñ–∞–π–ª —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏–ª—Å—è –≤ —Ç–µ—Å—Ç–æ–≤–æ–π –ø–∞–ø–∫–µ `uploads/storage/...`.
3.  **Feed:** GET `/media/feed` -> –í —Å–ø–∏—Å–∫–µ –µ—Å—Ç—å –Ω–∞—à–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞.
4.  **Upload Duplicate:** –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—Ç –∂–µ `cat.jpg` –µ—â–µ —Ä–∞–∑ -> 200 OK.
    *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ —Ñ–∞–π–ª –û–î–ò–ù (–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Å—Ä–∞–±–æ—Ç–∞–ª–∞).
    *   –í –ë–î –¥–≤–µ –∑–∞–ø–∏—Å–∏ `images` —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ –æ–¥–∏–Ω `file`.
5.  **Delete 1:** –£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–≤—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É.
    *   –§–∞–π–ª –Ω–∞ –¥–∏—Å–∫–µ –¥–æ–ª–∂–µ–Ω –û–°–¢–ê–¢–¨–°–Ø (—Ç–∞–∫ –∫–∞–∫ –µ—Å—Ç—å –≤—Ç–æ—Ä–∞—è —Å—Å—ã–ª–∫–∞).
6.  **Delete 2:** –£–¥–∞–ª–∏—Ç—å –≤—Ç–æ—Ä—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É.
    *   –§–∞–π–ª –Ω–∞ –¥–∏—Å–∫–µ –¥–æ–ª–∂–µ–Ω –ò–°–ß–ï–ó–ù–£–¢–¨ (—Å—á–µ—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ = 0).

---

## üõ†Ô∏è Fixtures & Mocks

*   `mock_media_repo`: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –º–æ–∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
*   `temp_storage_dir`: –§–∏–∫—Å—Ç—É—Ä–∞ `pytest`, —Å–æ–∑–¥–∞—é—â–∞—è –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –∏ –æ—á–∏—â–∞—é—â–∞—è –µ—ë –ø–æ—Å–ª–µ.
*   `sample_image_file`: –ë–∞–π—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤–∞–ª–∏–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (1x1 –ø–∏–∫—Å–µ–ª—å) –¥–ª—è —Ç–µ—Å—Ç–æ–≤.

---
[üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é](../../../../index.md)
