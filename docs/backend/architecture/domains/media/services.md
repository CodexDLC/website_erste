[üè† Home](../../../../index.md) > [Backend](../../../index.md) > [Architecture](../../index.md) > [Domains](../index.md) > [Media](./index.md)

# üß† Business Logic (Services)

## `MediaService`

–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä, —É–ø—Ä–∞–≤–ª—è—é—â–∏–π –∑–∞–≥—Ä—É–∑–∫–æ–π, –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∏ —É–¥–∞–ª–µ–Ω–∏–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

### `upload_image(user_id: UUID, file: UploadFile, filename: str) -> Image`
1.  **Hashing:** –ß–∏—Ç–∞–µ—Ç –ø–æ—Ç–æ–∫ —Ñ–∞–π–ª–∞ –∏ –≤—ã—á–∏—Å–ª—è–µ—Ç SHA-256 —Ö–µ—à.
2.  **Deduplication Check:** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –≤ –ë–î (`repo.get_file_by_hash`).
    *   **–í–µ—Ç–∫–∞ "–ù–æ–≤—ã–π —Ñ–∞–π–ª" (Miss):**
        1.  –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª –Ω–∞ –¥–∏—Å–∫ (Atomic Write).
        2.  –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–∏–Ω–∏–∞—Ç—é—Ä—É (thumbnail) —á–µ—Ä–µ–∑ Pillow.
        3.  –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–∏–Ω–∏–∞—Ç—é—Ä—É —Ä—è–¥–æ–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º.
        4.  –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ñ–∞–π–ª –≤ –ë–î (`repo.create_file`).
    *   **–í–µ—Ç–∫–∞ "–î—É–±–ª–∏–∫–∞—Ç" (Hit):**
        1.  –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ –¥–∏—Å–∫ (—Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç).
3.  **Linking:** –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`repo.create_image`), —Å–≤—è–∑—ã–≤–∞—è `user_id` –∏ `file_hash`.
4.  **Return:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏.

### `get_public_feed(limit: int, offset: int) -> List[ImageFeedSchema]`
1.  –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (`repo.get_public_images`).
2.  –§–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç, –æ—Ç–¥–∞–≤–∞—è —Å—Å—ã–ª–∫—É **—Ç–æ–ª—å–∫–æ –Ω–∞ –º–∏–Ω–∏–∞—Ç—é—Ä—É** (`_thumb.jpg`) –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–µ–Ω—Ç—ã.

### `get_image_details(image_id: UUID) -> ImageDetailSchema`
1.  –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ ID (`repo.get_image_by_id`).
    *   –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –æ—à–∏–±–∫–∞ `404 Not Found`.
2.  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç:
    *   –°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª.
    *   –°—Å—ã–ª–∫–∞ –Ω–∞ –º–∏–Ω–∏–∞—Ç—é—Ä—É.
    *   –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–µ.
    *   –î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏.

### `delete_image(user_id: UUID, image_id: UUID)`
1.  **Auth Check:** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (`image.user_id == user_id`).
    *   –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ—à–∏–±–∫–∞ `403 Forbidden`.
2.  **Soft Delete:** –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `images` (`repo.delete_image`).
3.  **Garbage Collection (GC):**
    1.  –ë–µ—Ä–µ—Ç `file_hash` —É–¥–∞–ª–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏.
    2.  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (`repo.get_usage_count`).
    3.  **–ï—Å–ª–∏ —Å—á–µ—Ç—á–∏–∫ == 0:**
        *   –£–¥–∞–ª—è–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ñ–∞–π–ª –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ —Å –¥–∏—Å–∫–∞.
        *   –£–¥–∞–ª—è–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ñ–∞–π–ª –º–∏–Ω–∏–∞—Ç—é—Ä—ã —Å –¥–∏—Å–∫–∞.
        *   –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `files` (`repo.delete_file`).

---
[üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é](../../../../index.md)
