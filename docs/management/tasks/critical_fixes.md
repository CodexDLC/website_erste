[üè† Home](../../index.md) > [Management](../index.md) > [Tasks](./index.md)

# üö® Task: Critical Fixes (Docs vs Code Mismatch)

**Status:** ‚úÖ Done
**Priority:** Critical
**Phase:** 3.5 (Stabilization before Frontend)

## üìù –û–ø–∏—Å–∞–Ω–∏–µ
–í —Ö–æ–¥–µ –∞—É–¥–∏—Ç–∞ –≤—ã—è–≤–ª–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –º–µ–∂–¥—É –∑–∞—è–≤–ª–µ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π) –∏ —Ä–µ–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π –≤ –∫–æ–¥–µ. –≠—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã –±–ª–æ–∫–∏—Ä—É—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –∏ –Ω–∞—Ä—É—à–∞—é—Ç –ø—Ä–∏–Ω—Ü–∏–ø—ã —Å–∏—Å—Ç–µ–º—ã.

## üìã –°–ø–∏—Å–æ–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### 1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–∏–Ω–∏–∞—Ç—é—Ä (Thumbnails)
**–ü—Ä–æ–±–ª–µ–º–∞:**
*   –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã (`_thumb.jpg`) —á–µ—Ä–µ–∑ Pillow.
*   –í `MediaService.upload_image` —ç—Ç–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –§–∞–π–ª –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.
*   –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ `pillow` –µ—Å—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ (–í—ã–ø–æ–ª–Ω–µ–Ω–æ):**
1.  –í–Ω–µ–¥—Ä–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ `MediaService`.
2.  –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª–∞:
    *   –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ñ–∞–π–ª —á–µ—Ä–µ–∑ `PIL`.
    *   –°–æ–∑–¥–∞–µ—Ç—Å—è –º–∏–Ω–∏–∞—Ç—é—Ä–∞ (`300px` –ø–æ —à–∏—Ä–æ–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–µ).
    *   –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–∏–Ω–∏–∞—Ç—é—Ä–∞ —Ä—è–¥–æ–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–æ–º (–∏–º—è —Ñ–∞–π–ª–∞: `{hash}_thumb.jpg`).
3.  –û–±–Ω–æ–≤–ª–µ–Ω API –æ—Ç–¥–∞—á–∏ —Ñ–∞–π–ª–æ–≤: –¥–æ–±–∞–≤–ª–µ–Ω —ç–Ω–¥–ø–æ–∏–Ω—Ç `GET /media/{hash}/thumb`.

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Garbage Collection (–£—Ç–µ—á–∫–∞ –º–µ—Å—Ç–∞)
**–ü—Ä–æ–±–ª–µ–º–∞:**
*   –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —Ñ–∞–π–ª–∞, –∫–æ–≥–¥–∞ —Å—á–µ—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ (`ref_count`) –ø–∞–¥–∞–µ—Ç –¥–æ 0.
*   –í `MediaService.delete_image` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `images`.
*   –§–∏–∑–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ –ø–∞–ø–∫–µ `storage` –Ω–∞–≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞ –Ω–∏—Ö –Ω–∏–∫—Ç–æ –Ω–µ —Å—Å—ã–ª–∞–µ—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ (–í—ã–ø–æ–ª–Ω–µ–Ω–æ):**
1.  –í –º–µ—Ç–æ–¥–µ `delete_image`:
    *   –ü–æ–ª—É—á–∞–µ–º `file_hash` —É–¥–∞–ª—è–µ–º–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏.
    *   –í—ã–ø–æ–ª–Ω—è–µ–º `repo.delete_image`.
    *   –ü—Ä–æ–≤–µ—Ä—è–µ–º `repo.get_usage_count(file_hash)`.
2.  –ï—Å–ª–∏ —Å—á–µ—Ç—á–∏–∫ —Ä–∞–≤–µ–Ω 0:
    *   –£–¥–∞–ª—è–µ–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ñ–∞–π–ª –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ —Å –¥–∏—Å–∫–∞.
    *   –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –º–∏–Ω–∏–∞—Ç—é—Ä—ã —Å –¥–∏—Å–∫–∞.
    *   –í—ã–∑—ã–≤–∞–µ–º `repo.delete_file(file_hash)` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Ñ–∞–π–ª–æ–≤.

### 3. –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ JWT (Broken Auth)
**–ü—Ä–æ–±–ª–µ–º–∞:**
*   –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞ –≤ –ø–æ–ª–µ `sub` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è `user_id` (UUID).
*   –ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–∫–µ–Ω–∞ (`get_current_user`) —ç—Ç–æ—Ç `sub` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ `get_by_email`.
*   **–ò—Ç–æ–≥:** –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–∞–∫ –∫–∞–∫ UUID –Ω–µ —è–≤–ª—è–µ—Ç—Å—è email-–æ–º.

**–†–µ—à–µ–Ω–∏–µ (–í—ã–ø–æ–ª–Ω–µ–Ω–æ):**
1.  –í `backend/dependencies/auth.py`:
    *   –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `email` –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –≤ `user_id_str`.
    *   –°—Ç—Ä–æ–∫–∞ –∏–∑ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ `uuid.UUID`.
    *   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ç–æ–¥ `user_repository.get_by_id(user_id)` –≤–º–µ—Å—Ç–æ `get_by_email`.

---
[‚¨ÖÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –∑–∞–¥–∞—á](./index.md)
